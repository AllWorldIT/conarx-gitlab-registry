# Event notifications spec

The current notification system for the container registry is a simple component that sends events to a configured endpoint(s).
The registry can be configured to send such notifications as [shown in the documentation](../../docs/configuration.md#notifications).

## Events payload

Below is a sample payload of an event notification sent by the registry on different `actions` for different `mediaTypes`.

```json
{
  "events": [
    {
      "id": "a582a0f3-e620-43e6-8e98-ff850fc9d984",
      "timestamp": "2023-01-25T14:45:54.17327+11:00",
      "action": "push",
      "target": {
        "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
        "size": 528,
        "digest": "sha256:af06af3514c44a964d3b905b498cf6493db8f1cde7c10e078213a89c87308ba0",
        "length": 528,
        "repository": "root/test",
        "url": "http://registry.test:5000/v2/root/test/manifests/sha256:af06af3514c44a964d3b905b498cf6493db8f1cde7c10e078213a89c87308ba0",
        "tag": "latest"
      },
      "request": {
        "id": "8ef8d69b-f957-45ab-ba2c-9153291f47b6",
        "addr": "172.16.123.1:56969",
        "host": "registry.test:5000",
        "method": "PUT",
        "useragent": "docker/20.10.18 go/go1.18.6 git-commit/e42327a6d3c55ceda3bd5475be7aae6036d02db3 kernel/5.15.68-0-virt os/linux arch/arm64 UpstreamClient(Docker-Client/20.10.22 \\(darwin\\))"
      },
      "actor": {
        "name": "root",
        "user_type": "personal_access_token"
      },
      "source": {
        "addr": "127.0.0.1:5000",
        "instanceID": "45681f21-a006-42f2-ab7c-4cc37d8906b4"
      },
      "meta":{
        "blob":{
            "redirected": true,
            "storageBackend": "s3aws"
        }
      }
    }
  ]
}
```

### Payload description

| Field       | Type   | Always present | Description                                                                                                                                                 |
|-------------|--------|----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `events`    | Array  | Yes            | Collection of different events that can be sent at the same time in a single payload. There is currently no size limit. Typically 1 event per notification. |
| `id`        | String | Yes            | UUID generated by the registry which identifies the event.                                                                                                  |
| `timestamp` | String | Yes            | Datetime following the [RFC3339 specification](https://www.rfc-editor.org/rfc/rfc3339).                                                                     |
| `action`    | String | Yes            | Represents the action that happened on the registry for a `target`. Possible values are <code>push&#124;pull&#124;delete&#124;mount</code>.                 |
| `target`    | Object | Yes            | See [`target`](#target).                                                                                                                                    |
| `request`   | Object | Yes            | See [`request`](#request).                                                                                                                                  |
| `actor`     | Object | Yes            | See [`actor`](#actor).                                                                                                                                      |
| `source`    | Object | Yes            | See [`source`](#source).                                                                                                                                    |
| `meta`      | Object | No             | Meta contains additional (optional) information related to an event. See [`meta`](#meta).                                                                                                                                      |

#### `target`

| Field            | Type   | Always present | Description                                                                                         |
|------------------|--------|----------------|-----------------------------------------------------------------------------------------------------|
| `mediaType`      | Array  | Yes            | MediaType describe the type of the content. All text based formats are encoded as utf-8.            |
| `size`           | String | Yes            | Size in bytes of content.                                                                           |
| `digest`         | String | Yes            | Digest uniquely identifies the content. A byte stream can be verified against this digest.          |
| `length`         | String | Yes            | Length in bytes of content. Same as Size field in Descriptor. Provided for backwards compatibility. |
| `repository`     | String | Yes            | Repository identifies the named repository.                                                         |
| `fromRepository` | String | No             | FromRepository identifies the named repository which a blob was mounted from for `mount` actions.   |
| `url`            | String | Yes            | URL provides a direct link to the content.                                                          |
| `tag`            | String | No             | Tag provides the tag assocciated with the `mediaType` if exists.                                    |
| `references`     | Array  | No             | It may contain a list of objects which make up a manifest.                                          |

#### `request`

| Field       | Type   | Always present | Description                                                                                                                 |
|-------------|--------|----------------|-----------------------------------------------------------------------------------------------------------------------------|
| `id`        | String | Yes            | Uniquely identifies the request that initiated the event.                                                                   |
| `addr`      | String | No             | Contains the IP or hostname and possibly port of the client connection that initiated the event.                            |
| `host`      | String | No             | Is the externally accessible host name of the registry instance, as specified by the http host header on incoming requests. |
| `method`    | String | Yes            | Has the request method that generated the event.                                                                            |
| `useragent` | String | Yes            | Contains the user agent header of the request.                                                                              |

#### `actor`

| Field       | Type   | Always present | Description                                                                                                                   |
|-------------|--------|----------------|-------------------------------------------------------------------------------------------------------------------------------|
| `name`      | String | No             | Name corresponds to the subject or username associated with the request context that generated the event.                     |
| `user_type` | String | No             | Present when authentication was used and the type can be identified by the authentication service. See possible values below. |

##### `user_type`

| User type                 | Definition                                                                                                                                                                       |
|---------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `deploy_token`            | `action` performed by an authenticated [deploy token](https://docs.gitlab.com/ee/user/project/deploy_tokens/#pull-images-from-a-container-registry).                             |
| `personal_access_token`   | [Personal access tokens](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#personal-access-token-scopes) with the `read_registry` or `write_registry` scopes.  |
| `build`                   | Refers to the `CI_JOB_TOKEN` available in [GitLab CI/CD](https://docs.gitlab.com/ee/ci/jobs/ci_job_token.html#gitlab-cicd-job-token) pipelines.                                  |
 | `gitlab_or_ldap`          | When the user logged in via username and password. Or when [LDAP](https://docs.gitlab.com/ee/administration/auth/ldap/) was used to login.                                       |
| `""`                      | The user type might be empty when there was no authentication required. For example, pulling public images from the registry.                                                    |

#### `source`

| Field        | Type   | Always present | Description                                                                             |
|--------------|--------|----------------|-----------------------------------------------------------------------------------------|
| `addr`       | String | No             | Contains the IP or hostname and the port of the registry node that generated the event. |
| `instanceID` | String | No             | Identifies a running instance of the registry node.                                     |


#### `meta`

| Field        | Type   | Always present | Description                                                                             |
|--------------|--------|----------------|-----------------------------------------------------------------------------------------|
| `blob`       | Object | No             | Only present on blob download events. Contains additional metadata on downloaded blobs. See [`blob`](#blob)                               |

#### `blob`

| Field             | Type    | Always present | Description                                                                                                               |
|-------------------|---------|----------------|---------------------------------------------------------------------------------------------------------------------------|
| `redirected`      | Boolean | Yes            | Identifies if a blob download request was served via a redirect url to the requesting client.                                                                                                         |
| `storageBackend`  | String  | Yes            | Identifies the backend that was used to serve a blob download request. This is always the configured storage backend (and not the redirect url provider) until  https://gitlab.com/gitlab-org/container-registry/-/issues/1003 is addressed.  |
